{% extends "base.html" %}
{% load static %}

{% block title %}領収書の修正{% endblock title %}

{% block content %}
<h1 class="text-3xl font-bold mb-4">領収書の内容を修正</h1>

<div id="accordion">
  <!-- アコーディオンのコンテンツがここに追加されます -->
</div>

<button type="button" id="complete-button" class="bg-green-500 py-2 px-4 rounded mt-4">編集を完了する</button>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];

    uploadedFiles.forEach((fileData, index) => {
        addAccordionItem(fileData, index);
    });
});

function addAccordionItem(fileData, index) {
    const accordion = document.getElementById('accordion');

    const item = document.createElement('div');
    item.classList.add('accordion-item', 'mb-4', 'border', 'border-gray-300', 'rounded');
    item.innerHTML = `
        <div class="accordion-header cursor-pointer bg-gray-200 p-4" onclick="toggleAccordion(${index})">
            <h2 class="text-xl">${fileData.name}</h2>
        </div>
        <div class="accordion-content p-4 hidden" id="accordion-content-${index}">
            <img src="${fileData.data}" alt="${fileData.name}" class="mb-4">
            <form class="edit-form">
                <div>
                    <label for="company-${index}" class="block text-gray-700">会社名:</label>
                    <textarea id="company-${index}" class="w-full p-2 border border-gray-300 rounded" rows="1">サンプル株式会社</textarea>
                </div>
                <div>
                    <label for="date-${index}" class="block text-gray-700 mt-4">日付:</label>
                    <textarea id="date-${index}" class="w-full p-2 border border-gray-300 rounded" rows="1">2024-05-31</textarea>
                </div>
                <div>
                    <label for="items-${index}" class="block text-gray-700 mt-4">項目:</label>
                    <div id="items-${index}">
                        <div class="item-field mb-4">
                            <label for="item-name-${index}-0" class="block text-gray-700">項目名:</label>
                            <textarea id="item-name-${index}-0" class="w-full p-2 border border-gray-300 rounded" rows="1">商品1</textarea>
                            <label for="item-price-${index}-0" class="block text-gray-700 mt-2">価格:</label>
                            <textarea id="item-price-${index}-0" class="w-full p-2 border border-gray-300 rounded" rows="1">1000</textarea>
                        </div>
                        <div class="item-field mb-4">
                            <label for="item-name-${index}-1" class="block text-gray-700">項目名:</label>
                            <textarea id="item-name-${index}-1" class="w-full p-2 border border-gray-300 rounded" rows="1">商品2</textarea>
                            <label for="item-price-${index}-1" class="block text-gray-700 mt-2">価格:</label>
                            <textarea id="item-price-${index}-1" class="w-full p-2 border border-gray-300 rounded" rows="1">2000</textarea>
                        </div>
                    </div>
                    <button type="button" onclick="addItemField(${index})" class="bg-blue-500 py-2 px-4 rounded mt-2">項目を追加</button>
                </div>
                <div>
                    <label for="total-${index}" class="block text-gray-700 mt-4">合計:</label>
                    <textarea id="total-${index}" class="w-full p-2 border border-gray-300 rounded" rows="1" readonly>3000</textarea>
                </div>
            </form>
        </div>
    `;
    accordion.appendChild(item);

    calculateTotal(index);

    // 項目の価格が変更された場合に合計を再計算
    document.querySelectorAll(`#accordion-content-${index} .item-field textarea[id^="item-price-"]`).forEach(priceField => {
        priceField.addEventListener('input', function() {
            calculateTotal(index);
        });
    });
}

function toggleAccordion(index) {
    const content = document.getElementById(`accordion-content-${index}`);
    content.classList.toggle('hidden');
}

function addItemField(index) {
    const itemsDiv = document.getElementById(`items-${index}`);
    const itemCount = itemsDiv.querySelectorAll('.item-field').length;

    const itemDiv = document.createElement('div');
    itemDiv.classList.add('item-field', 'mb-4');
    itemDiv.innerHTML = `
        <label for="item-name-${index}-${itemCount}" class="block text-gray-700">項目名:</label>
        <textarea id="item-name-${index}-${itemCount}" class="w-full p-2 border border-gray-300 rounded" rows="1"></textarea>
        <label for="item-price-${index}-${itemCount}" class="block text-gray-700 mt-2">価格:</label>
        <textarea id="item-price-${index}-${itemCount}" class="w-full p-2 border border-gray-300 rounded" rows="1"></textarea>
        <button type="button" class="remove-item bg-red-500 py-1 px-2 rounded mt-2" onclick="removeItemField(this, ${index})">削除</button>
    `;
    itemsDiv.appendChild(itemDiv);

    // 項目の価格が変更された場合に合計を再計算
    itemDiv.querySelector(`textarea[id^="item-price-"]`).addEventListener('input', function() {
        calculateTotal(index);
    });
}

function removeItemField(button, index) {
    button.closest('.item-field').remove();
    calculateTotal(index);
}

function calculateTotal(index) {
    const prices = document.querySelectorAll(`#accordion-content-${index} .item-field textarea[id^="item-price-"]`);
    let total = 0;
    prices.forEach(priceField => {
        const price = parseFloat(priceField.value);
        if (!isNaN(price)) {
            total += price;
        }
    });
    document.getElementById(`total-${index}`).value = total;
}

document.getElementById('complete-button').addEventListener('click', async function() {
    const accordionItems = document.querySelectorAll('.accordion-item');

    const receiptData = Array.from(accordionItems).map((item, index) => {
        const company = document.getElementById(`company-${index}`).value;
        const date = document.getElementById(`date-${index}`).value;
        const items = [];

        document.querySelectorAll(`#accordion-content-${index} .item-field`).forEach((itemField, itemIndex) => {
            const name = itemField.querySelector(`#item-name-${index}-${itemIndex}`).value;
            const price = parseFloat(itemField.querySelector(`#item-price-${index}-${itemIndex}`).value);
            if (!isNaN(price)) {
                items.push({ name: name, price: price });
            }
        });

        const total = parseFloat(document.getElementById(`total-${index}`).value);

        return {
            company: company,
            date: date,
            items: items,
            total: total
        };
    });

    // モックの非同期処理（テキストデータ送信）
    await mockSendTextData(receiptData);

    // 非同期処理が完了したら/save_completeに遷移
    window.location.href = "/save_complete";
});

async function mockSendTextData(data) {
    // ここで非同期に外部APIを呼び出す処理をモック
    console.log('Sending text data:', data);
    return new Promise(function(resolve) {
        setTimeout(function() {
            resolve();
        }, 3000); // 3秒待機するモック
    });
}
</script>
{% endblock content %}
