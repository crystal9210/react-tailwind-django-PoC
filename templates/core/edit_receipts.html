{% extends "base.html" %}
{% load static %}

{% block title %}領収書の修正{% endblock title %}

{% block content %}
{% comment %}
{% block extra_js %}
<script src="{% static 'frontend/upload_receipts.js' %}"></script>
{% endblock extra_js %}
{% endcomment %}
<h1 class="text-3xl font-bold mb-4">領収書の内容を修正</h1>
<form id="edit-form">
  <div id="receipts-content" class="mb-4">
    <label for="company" class="block text-gray-700">会社名:</label>
    <textarea id="company" class="w-full p-2 border border-gray-300 rounded" rows="1"></textarea>

    <label for="date" class="block text-gray-700 mt-4">日付:</label>
    <textarea id="date" class="w-full p-2 border border-gray-300 rounded" rows="1"></textarea>

    <label for="items" class="block text-gray-700 mt-4">項目:</label>
    <div id="items">
      <!-- 項目の編集フィールドがここに追加されます -->
    </div>
    <button type="button" id="add-item" class="bg-blue-500 py-2 px-4 rounded mt-2">項目を追加</button>

    <label for="total" class="block text-gray-700 mt-4">合計:</label>
    <textarea id="total" class="w-full p-2 border border-gray-300 rounded" rows="1" readonly></textarea>
  </div>
  <button type="submit" class="bg-blue-500 py-2 px-4 rounded">保存</button>
  <button type="button" id="complete-button" class="bg-green-500 py-2 px-4 rounded mt-2">編集を完了する</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mockReceiptData = {
        company: "サンプル株式会社",
        date: "2024-05-31",
        items: [
            { name: "商品1", price: 1000 },
            { name: "商品2", price: 2000 }
        ],
        total: 3000
    };

    document.getElementById('company').value = mockReceiptData.company;
    document.getElementById('date').value = mockReceiptData.date;

    mockReceiptData.items.forEach((item, index) => {
        addItemField(item.name, item.price, index);
    });

    calculateTotal();

    document.getElementById('add-item').addEventListener('click', function() {
        addItemField('', '', document.querySelectorAll('.item-field').length);
    });
});

function addItemField(name, price, index) {
    const itemDiv = document.createElement('div');
    itemDiv.classList.add('item-field', 'mb-4');
    itemDiv.innerHTML = `
        <label for="item-name-${index}" class="block text-gray-700">項目名:</label>
        <textarea id="item-name-${index}" class="w-full p-2 border border-gray-300 rounded" rows="1">${name}</textarea>
        
        <label for="item-price-${index}" class="block text-gray-700 mt-2">価格:</label>
        <textarea id="item-price-${index}" class="w-full p-2 border border-gray-300 rounded" rows="1">${price}</textarea>

        <button type="button" class="remove-item bg-red-500 py-1 px-2 rounded mt-2" data-index="${index}">削除</button>
    `;
    document.getElementById('items').appendChild(itemDiv);

    itemDiv.querySelector('.remove-item').addEventListener('click', function() {
        itemDiv.remove();
        calculateTotal();
    });

    itemDiv.querySelector(`#item-price-${index}`).addEventListener('input', function() {
        calculateTotal();
    });
}

function calculateTotal() {
    const prices = document.querySelectorAll('.item-field textarea[id^="item-price-"]');
    let total = 0;
    prices.forEach(priceField => {
        const price = parseFloat(priceField.value);
        if (!isNaN(price)) {
            total += price;
        }
    });
    document.getElementById('total').value = total;
}

document.getElementById('edit-form').addEventListener('submit', function(event) {
    event.preventDefault(); // フォームのデフォルト動作を防止
    // 保存ボタンが押されたときの処理をここに追加します
    console.log('保存ボタンが押されました');
});

document.getElementById('complete-button').addEventListener('click', async function() {
    const company = document.getElementById('company').value;
    const date = document.getElementById('date').value;

    const items = [];
    document.querySelectorAll('.item-field').forEach((itemField, index) => {
        const name = itemField.querySelector(`#item-name-${index}`).value;
        const price = parseFloat(itemField.querySelector(`#item-price-${index}`).value);
        if (!isNaN(price)) {
            items.push({ name: name, price: price });
        }
    });

    const total = parseFloat(document.getElementById('total').value);

    const textData = {
        company: company,
        date: date,
        items: items,
        total: total
    };

    // モックの非同期処理（テキストデータ送信）
    await mockSendTextData(textData);

    // 非同期処理が完了したら/save_completeに遷移
    window.location.href = "/save_complete";
});

async function mockSendTextData(data) {
    // ここで非同期に外部APIを呼び出す処理をモック
    console.log('Sending text data:', data);
    return new Promise(function(resolve) {
        setTimeout(function() {
            resolve();
        }, 3000); // 3秒待機するモック
    });
}
</script>
{% endblock content %}
